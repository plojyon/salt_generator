<!DOCTYPE html>
<html>
	<head>
		<title>Salt generator</title>
		<meta charset="utf-8"/>
	</head>
	<body>

		<center>
			<table border="1">
				<tr>
					<td class="ime">Ime</td><td>Formula</td>
				</tr>
				<tr>
					<td class="ime" id="name">Error</td><td id="formula">Er</td>
				</tr>
			</table>
			<h5>Click anywhere on the table to continue</h5>
			<p>Score: <span id="score">0</span></p>
			<br><br>
			Guessing:
			<select id="guessing">
				<option value="formula" selected>formula</option>
				<option value="name">name</option>
				<option value="random">random</option>
			</select>
		</center>


		<style>
			table {
				width: 30em;
				margin-top: 5em;
				cursor: pointer;
			}
			tbody {
				height: 3.5em;
				display: flex;
				flex-direction: column;
			}
			tr:first-child td {
				font-weight: bold;
				background-color: lightgray;
			}
			tr {
				display: flex;
				flex: 1;
			}
			td {
				flex: 1;
				text-align: center;
			}
			.ime {
				flex: 2;
			}
		</style>


		<script>
			function getRandomInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}
			function lcm(x, y) {
				return (!x || !y) ? 0 : Math.abs((x * y) / gcd_two_numbers(x, y));
			}
			function gcd_two_numbers(x, y) {
				x = Math.abs(x);
				y = Math.abs(y);
				while(y) {
					var t = y;
					y = x % y;
					x = t;
				}
				return x;
			}
			function romanize(num) {
				if (!+num)
					return NaN;
				var digits = String(+num).split(""),
					key = ["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM",
						"","X","XX","XXX","XL","L","LX","LXX","LXXX","XC",
						"","I","II","III","IV","V","VI","VII","VIII","IX"],
						roman = "",
						i = 3;
				while (i--)
					roman = (key[+digits.pop() + (i * 10)] || "") + roman;
				return Array(+digits.join("") + 1).join("M") + roman;
			}


			var anioni = [
				{"name": "cianid", "formula": "CN", "naboj": 1, "needsParentheses": true},
				{"name": "sulfid", "formula": "F", "naboj": 2},
				{"name": "hidrogensulfid", "formula": "HF", "naboj": 1, "needsParentheses": true},
				{"name": "nitrat(V)", "formula": "NO<sub>2</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "sulfat(VI)", "formula": "SO<sub>4</sub>", "naboj": 2, "needsParentheses": true},
				{"name": "hidrogensulfat(VI)", "formula": "HSO<sub>4</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "sulfat(IV)", "formula": "SO<sub>3</sub>", "naboj": 2, "needsParentheses": true},
				{"name": "hidrogensulfat(IV)", "formula": "HSO<sub>3</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "karbonat", "formula": "CO<sub>3</sub>", "naboj": 2, "needsParentheses": true},
				{"name": "hidrogenkarbonat", "formula": "HCO<sub>3</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "fosfat(V)", "formula": "PO<sub>4</sub>", "naboj": 3, "needsParentheses": true},
				{"name": "hidrogenfosfat(V)", "formula": "HPO<sub>4</sub>", "naboj": 2, "needsParentheses": true},
				{"name": "dihidrogenfosfat(V)", "formula": "H<sub>2</sub>PO<sub>4</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "fosfat(III)", "formula": "PO<sub>3</sub>", "naboj": 3, "needsParentheses": true},
				{"name": "hidrogenfosfat(III)", "formula": "HPO<sub>3</sub>", "naboj": 2, "needsParentheses": true},
				{"name": "dihidrogenfosfat(III)", "formula": "H<sub>2</sub>PO<sub>3</sub>", "naboj": 1, "needsParentheses": true},
				{"name": "klorat(I)", "formula": "ClO", "naboj": 1, "needsParentheses": true},
				{"name": "bromat(I)", "formula": "BrO", "naboj": 1, "needsParentheses": true},
				{"name": "jodat(I)", "formula": "IO", "naboj": 1, "needsParentheses": true},
				{"name": "klorid", "formula": "Cl", "naboj": 1, "needsParentheses": true},
				{"name": "bromid", "formula": "Br", "naboj": 1, "needsParentheses": true},
				{"name": "jodid", "formula": "I", "naboj": 1, "needsParentheses": true},
				{"name": "klorat(VII)", "formula": "ClO<sub>4</sub>", "naboj": 1, "needsParentheses": true}
			]

			var kationi_common = [
				{"name": "Litijev", "formula": "Li", "naboj": 1},
				{"name": "Natrijev", "formula": "Na", "naboj": 1},
				{"name": "Kalijev", "formula": "K", "naboj": 1},
				{"name": "Rubidijev", "formula": "Rb", "naboj": 1},
				{"name": "Berilijev", "formula": "Be", "naboj": 2},
				{"name": "Magnezijev", "formula": "Mg", "naboj": 2},
				{"name": "Kalcijev", "formula": "Ca", "naboj": 2},
				{"name": "Stroncijev", "formula": "Sr", "naboj": 2},
				{"name": "Barijev", "formula": "Ba", "naboj": 2},
				{"name": "Amonijev", "formula": "NH<sub>4</sub>", "naboj": 1, "needsParentheses": true}
			]

			var kationi_prehoda = [
				{"name": "Skandijev", "formula": "Sc", "naboj": [3]},
				{"name": "Titanov", "formula": "Ti", "naboj": [4, 3, 2]},
				{"name": "Vanadijev", "formula": "V", "naboj": [5, 4, 3, 2]},
				{"name": "Kromov", "formula": "Cr", "naboj": [6, 3, 2]},
				{"name": "Manganov", "formula": "Mn", "naboj": [7, 4, 3, 2]},
				{"name": "Å½elezov", "formula": "Fe", "naboj": [3, 2]},
				{"name": "Kobaltov", "formula": "Co", "naboj": [3, 2]},
				{"name": "Nikljev", "formula": "Ni", "naboj": [3, 2]},
				{"name": "Bakrov", "formula": "Cu", "naboj": [2, 1]},
				{"name": "Cinkov", "formula": "Zn", "naboj": [2]}
			]

			var pendingPair = getRandomPair();
			var isPending = false;
			var score = -0.5;
			pendPair(getRandomPair());
			document.getElementsByTagName('table')[0].addEventListener("click", function() { pendPair(getRandomPair()); });

			function pendPair(newPair) {
				if (isPending) revealPair(pendingPair);
				else hidePair(newPair);
				isPending = !isPending;
				score += 0.5;
				document.getElementById("score").innerHTML = Math.ceil(score);
			}
			function hidePair(p) {
				pendingPair = p;
				document.getElementById("name").innerHTML = p[0];
				document.getElementById("formula").innerHTML = p[1];
				var dropdown = document.getElementById("guessing");
				var guessing = dropdown.options[dropdown.selectedIndex].value;
				if (guessing == "formula" || (guessing == "random" && Math.random() > 0.5))
					document.getElementById("formula").innerHTML = "?";
				else
					document.getElementById("name").innerHTML = "?";
			}
			function getRandomPair() {
				var anion = anioni[getRandomInt(0, anioni.length-1)];
				var kation = kationi_common[getRandomInt(0, kationi_common.length-1)];

				if (Math.random() > 0.3) { /* 70% chance of uncommon */
					var rand = kationi_prehoda[getRandomInt(0, kationi_common.length-1)];
					var naboj = rand.naboj[getRandomInt(0, rand.naboj.length-1)];
					kation = {"name": rand.name+"("+romanize(naboj)+")", "formula": rand.formula, "naboj": naboj};
				}

				var formula = createFormula(anion, kation);

				return [kation.name + " " + anion.name, formula];
			}
			function revealPair(pair) {
				document.getElementById("name").innerHTML = pair[0];
				document.getElementById("formula").innerHTML = pair[1];

				console.log(pair[0].split('<sub>').join('').split('</sub>').join('') + " : " + pair[1].split('<sub>').join('').split('</sub>').join(''));
			}
			function createFormula(anion, kation) {
				var veckratnik = lcm(Math.abs(anion.naboj), Math.abs(kation.naboj));
				var nabojAnion  = veckratnik /  anion.naboj;
				var nabojKation = veckratnik / kation.naboj;

				var an = anion.formula;
				if (nabojAnion != 1) {
					if (anion.needsParentheses) an = "(" + an + ")";
					an += "<sub>" + nabojAnion + "</sub>";
				}

				var ka = kation.formula;
				if (nabojKation != 1) {
					if (kation.needsParentheses) ka = "(" + ka + ")";
					ka += "<sub>" + nabojKation + "</sub>";
				}

				return ka + an;
			}
		</script>
	</body>
</html>
